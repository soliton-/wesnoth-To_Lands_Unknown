#textdomain wesnoth-To_Lands_Unknown
#define WATER_ELEMENTAL_TEXT
    [store_gold]
        side=1
        variable=mehirgold
    [/store_gold]
    {IF_VAR mehirgold less_than 23 (
        [and]
            [variable]
                name=badass_mode_active
                not_equals=yes
            [/variable]
        [/and]
        [or]
            [variable]
                name=mehirgold
                less_than=10
            [/variable]
            [variable]
                name=badass_mode_active
                equals=yes
            [/variable]
        [/or]
        [then]
            [message]
                speaker=Mehir
                message= _ "Ridiculous price aside, I can't quite afford the elemental."
            [/message]
            [message]
                speaker=merchant
                message= _ "Not surprising. Anyway, if there's something on sale that you <b>can</b> actually afford, feel free to have a look."
            [/message]
            [message]
                speaker=Mehir
                message= _ "I'll pass, thanks."
            [/message]
            {VARIABLE mehircantafford yes}
        [/then]
        [else]
            [message]
                speaker=Mehir
                message= _ "<i>*to himself* Hmmmm... on one hand, he's charging me most of the money I have, but on the other, a water elemental can be a great asset to have on duty...</i>"
                [option]
                    image="misc/blank-hex.png"
                    label= _ "I don't need an overpriced elemental!"
                    [command]
                        [message]
                            speaker=merchant
                            message= _ "Your loss. If you change your mind, feel free to come back, if the elemental isn't already sold out by then, that is."
                        [/message]
                        {VARIABLE boughtelemental no}
                    [/command]
                [/option]
                [option]
                    image="units/summoners-elementals/elemental-water1.png"
                    label= _ "Buy the elemental anyway (costs 20 gold, carries over to the next scenarios)"
                    [show_if]
                        [variable]
                            name=mehirgold
                            greater_than=19
                        [/variable]
                    [/show_if]
                    [command]
                        [gold]
                            side=1
                            amount=-20
                        [/gold]
                        [sound]
                            name=gold.ogg
                        [/sound]
                        {MODIFY_UNIT id=waterelemental side 1}
                        {VARIABLE boughtelemental yes}
                        [message]
                            speaker=merchant
                            message= _ "Excellent choice! Since I can see you're quite the elemental-savvy customer, may I also interest you in a brand-new freshly-summoned air avatar?"
                        [/message]
                        [message]
                            speaker=Mehir
                            image=portraits/mehir-angry.png
                            message= _ "Hell no! I've had more than enough overpriced elementals for one day!"
                        [/message]
                        [message]
                            speaker=merchant
                            message= _ "Sure. Anyway, enjoy your new water elemental!"
                        [/message]
                    [/command]
                [/option]
                [option]
                    image="icons/scroll_red.png"
                    label= _ "Check the merchant's license."
                    [show_if]
                        [variable]
                            name=badass_mode_active
                            equals=yes
                        [/variable]
                        [and]
                            [variable]
                                name=mehirgold
                                greater_than=9
                            [/variable]
                        [/and]
                    [/show_if]
                    [command]
                        {MODIFY_UNIT id=Mehir profile "portraits/mehir.png~BLIT(misc/sunglasses.png)"}
                        [message]
                            speaker=Mehir
                            message= _ "*ahem* I am from the City Guard. May I see your trade license?"
                        [/message]
                        [message]
                            speaker=merchant
                            message= _ "May I ask why you're so sudden about it?"
                        [/message]
                        [message]
                            speaker=Mehir
                            message= _ "All trading falls under the regulations imposed by the High Council. This is just a routine check."
                        [/message]
                        [message]
                            speaker=merchant
                            message= _ "(hands over the license) Uhh, sure, here you go."
                        [/message]
                        [message]
                            speaker=Mehir
                            message= _ "The license was valid until yesterday, thus you are trading illegally. The fine for that is ten gold."
                        [/message]
                        [message]
                            speaker=merchant
                            message= _ "What? No, I'm pretty sure the license was..."
                        [/message]
                        [message]
                            speaker=Mehir
                            message= _ "I don't care. A fine is a fine. You can pay in the town hall standing in the queue for a whole day or..."
                        [/message]
                        [message]
                            speaker=Mehir
                            message= _ "...sell me this water elemental for a reduced price. 20 gold minus the fine will be 10."
                        [/message]
                        [message]
                            speaker=merchant
                            message= _ "Damn, I can't afford losing a day standing in a queue. *sigh* Fine, a discount elemental it is. <i>*quietly* Man, the city guard these days...</i>"
                        [/message]
                        [message]
                            speaker=Mehir
                            message= _ "Good. If I see you tomorrow with that outdated license, I'll confiscate all your wares. You have been warned."
                        [/message]
                        [gold]
                            side=1
                            amount=-10
                        [/gold]
                        [sound]
                            name=gold.ogg
                        [/sound]
                        {MODIFY_UNIT id=waterelemental side 1}
                        {VARIABLE boughtelemental yes}
                        {MODIFY_UNIT id=Mehir profile "portraits/mehir.png"}
                    [/command]
                [/option]
            [/message]
        [/else])}
#enddef
#define CARPET_STORY
    [message]
        speaker=enchanter
        message= _ "By the way, you haven't told me what happened with this carpet of yours..."
    [/message]
    [message]
        speaker=Mehir
        message= _ "I am not sure you'd really want to know..."
    [/message]
    [message]
        speaker=enchanter
        message= _ "Oh, come on. Was it damaged during an important mission?"
    [/message]
    [message]
        speaker=Mehir
        message= _ "Well, uh, not exactly..."
    [/message]
    {BADASS_MODE_CHANGE (
        [message]
            speaker=Mehir
            message= _ "Not so long ago I met a beautiful girl. I wanted to impress her, so I took her on a ride..."
        [/message]
        {FADE_TO_BLACK}
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        [hide_unit]
        [/hide_unit]
        [unit]
            type=TLU_animhack
            variation=carpet-ride
            side=3
            x=8
            y=5
            facing=ne
            placement,overwrite=map,yes
        [/unit]
        [item]
            x=8
            y=5
            halo="movie_border960.png"
        [/item]
        [delay]
            time=2000
        [/delay]
        [message]
            speaker=narrator
            caption= _ "Mehir"
            image=portraits/mehir-girl.png
            message= _ "Do you like it, baby?"
        [/message]
        [message]
            speaker=narrator
            caption= _ "Girl"
            image=portraits/mehir-girl.png
            message= _ "Oh, yes! Flying so fast feels wonderful!"
        [/message]
        [message]
            speaker=narrator
            caption= _ "Mehir"
            image=portraits/mehir-girl.png
            message= _ "I know. Now look, I can fly without using my hands!"
        [/message]
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=narrator
            caption= _ "Girl"
            image=portraits/mehir-girl.png
            message= _ "Oh, Mehir! You are such a professional!"
        [/message]
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=narrator
            caption= _ "Mehir"
            image=portraits/mehir-girl2.png
            message= _ "That's not all. I can do this even with my eyes closed!"
        [/message]
        [message]
            speaker=narrator
            caption= _ "Girl"
            image=portraits/mehir-girl.png
            message= _ "Are you sure this is safe? WAIT THERE IS A WALL IN FRONT OF US!!!"
        [/message]
        [delay]
            time=500
        [/delay]

        [animate_unit]
            flag=ride-finish
            [filter]
                type=TLU_animhack
            [/filter]
            facing=ne
        [/animate_unit]
        [kill]
            type=TLU_animhack
            animate=no
        [/kill]
        {REMOVE_IMAGE 8 5}
        [delay]
            time=1000
        [/delay]
        [change_theme]
            theme=""
        [/change_theme]
        {FADE_IN}
        [unhide_unit]
        [/unhide_unit]
        [message]
            speaker=enchanter
            message= _ "Oh, I see. It had to hurt... What happened next?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "After she recovered, she turned me down. Said that flying with me is too dangerous... *sigh*"
        [/message]
        [message]
            speaker=enchanter
            message= _ "I am sorry to hear that..."
        [/message]) (
            [message]
                speaker=Mehir
                message= _ "I'd rather not talk about it..."
            [/message]
            [message]
                speaker=enchanter
                message= _ "All right, forget I asked."
            [/message]
        )}
#enddef
#define ENCHANTER_DIALOG
    [message]
        speaker=enchanter
        message= _ "Ah, Mehir, my old friend! Long time no see! Let me guess, you're here because your enchanted glove broke again?"
    [/message]
    [message]
        speaker=Mehir
        message= _ "Yeah, that piece of junk barely holds together."
    [/message]
    [message]
        speaker=enchanter
        message= _ "Not surprising, the garbage they give to city guard these days is nothing like the stuff used by the army. Though to be fair, there's really been no reason to properly arm them anyway, there's nobody who would dare attack the capital, and the city guard itself is just the product of the High Council's desperate attempts to give the human population something to do. I would fix the glove again, but you know what? It'll be easier to just make you a new one. This will take a few minutes."
    [/message]
    {REMOVE_IMAGE 7 5}
    {MOVE_UNIT id=enchanter 6 4}
    [message]
        speaker=enchanter
        message= _ "Anyway, how's the work been lately?"
    [/message]
    [message]
        speaker=Mehir
        message= _ "As usual, standing in one place for hours, and having to command the most incompetent troops in the entire city! I have to wrest them away from the inns every single damn evening, because they barely have any discipline at all! I bet that is the very reason they get assigned here in the first place..."
    [/message]
    [message]
        speaker=enchanter
        message= _ "Indeed, most of the city guard is bottom of the barrel troops not fit for service in the army but just barely tough enough to deal with petty crime, what little of it exists at least."
    [/message]
    [message]
        speaker=Mehir
        message= _ "Yeah. By the way, what's with all these incomplete circles on the floor?"
    [/message]
    [message]
        speaker=enchanter
        message= _ "They're just the product of me testing the properties of circle paint. Their glow is also quite soothing..."
    [/message]
    [message]
        speaker=Mehir
        message= _ "And how's the carpet I sent you for repairs a few months ago?"
    [/message]
    [message]
        speaker=enchanter
        message= _ "The one with the big hole burnt into the middle? Been trying to work on that thing for a while, but then gave up and given it to one of my colleagues. He's pretty darn good at dealing with enchanted fabric, unlike myself. It'll probably take a few more weeks before it's done."
    [/message]
    {BADASS_MODE_CHANGE (
        [message]
            speaker=Mehir
            message= _ "Forget about it, I've just got a new one. *makes an evil smile*"
        [/message]
    ) (
        [message]
            speaker=Mehir
            message= _ "Damn, I need this urgently. Those carpet ferrymen are soon going to financially ruin me..."
        [/message]
    )}
    {CARPET_STORY}
    {FADE_TO_BLACK}
    [delay]
        time=1000
    [/delay]
    {FADE_IN}
    {MOVE_UNIT id=enchanter 7 5}
    [object]
        silent=yes
        duration=forever
        [filter]
            id=Mehir
        [/filter]
        [effect]
            apply_to=variation
            name=
        [/effect]
    [/object]
    {MODIFY_UNIT id=Mehir profile "portraits/mehir.png"}#quickfix
    [message]
        speaker=enchanter
        message= _ "Anyway, the glove is complete! That'll be six gold."
    [/message]
    [store_gold]
        side=1
        variable=mehirgold
    [/store_gold]
    {IF_VAR mehirgold less_than 6 (
        [then]
            [message]
                speaker=Mehir
                message= _ "Uhh... I kind of forgot the money. Maybe send the bill to the High Council? I'm sure they'll pay. It is them who equip us with this junk after all."
            [/message]
            [message]
                speaker=enchanter
                message= _ "...right."
            [/message]
        [/then]
        [else]
            {BADASS_MODE_CHANGE (
                [message]
                    speaker=Mehir
                    message= _ "Send the bill to the High Council. Maybe they'll pay. It is them who equip us with this junk after all."
                [/message]
                [message]
                    speaker=enchanter
                    message= _ "...right."
                [/message]
            ) (
                [message]
                    speaker=Mehir
                    message= _ "Sure, here you go."
                [/message]
                [gold]
                    side=1
                    amount=-6
                [/gold]
                [sound]
                    name=gold.ogg
                [/sound]
            )}
        [/else]
    )}
    [message]
        speaker=enchanter
        message= _ "Want to try the glove in action? How about I summon an air elemental, and you shoot it down?"
    [/message]
    [message]
        speaker=Mehir
        message= _ "Sure! It's been a while since I've done any exercise."
    [/message]
    [message]
        speaker=enchanter
        message= _ "Here I go!"
    [/message]
    {MOVE_UNIT id=enchanter 8 5}
    {UNIT 3 (EoMa_Air_Elemental) 9 6 (animate,facing=yes,sw)}
    {MOVE_UNIT id=enchanter 7 5}
    {FORCE_CHANCE_TO_HIT id=Mehir side=3 100 ()}
    {MOVE_UNIT id=Mehir 8 6}
    {REPEAT 3 (
        [harm_unit]
            [filter]
                type=EoMa_Air_Elemental
            [/filter]
            [filter_second]
                id=Mehir
            [/filter_second]
            [primary_attack]
                name=magic arrow
            [/primary_attack]
            amount=9
            damage_type=fire
            experience=yes
            fire_event=no
            animate=yes
        [/harm_unit]
    )}
    [message]
        speaker=enchanter
        message= _ "This, my friend, is what a real magic missile glove looks like."
    [/message]
    [message]
        speaker=Mehir
        image=portraits/mehir-happy.png
        message= _ "Now I can bring law and justice to the streets!"
    [/message]
    {BADASS_MODE_CHANGE (
        [message]
            speaker=Mehir
            message= _ "...and make some people pay up. *smiles ominously*"
        [/message]
    ) ()}
    [delay]
        time=500
    [/delay]
    [message]
        speaker=Mehir
        message= _ "Alright, thanks for the help! I'll get going."
    [/message]
    [message]
        speaker=enchanter
        message= _ "Good luck on your duty!"
    [/message]
    {HIGHLIGHT_IMAGE 7 7 "items/gohere.png" ()}
    [objectives]
        side=1
        [objective]
            description= _ "Leave the workshop"
            condition=win
        [/objective]
        note= _ "This is a non-combat scenario:
-Mehir's movement refills after each move.
-You cannot skip your turn
-You can interact with NPCs that have yellow exclamation marks by moving next to them."
    [/objectives]
#enddef

#define JINN_PROPHECY
    [message]
        speaker=wjinn
        message= _ "Sure. Wait a minute, I need to focus..."
    [/message]
    [delay]
        time=500
    [/delay]
    [sound]
        name=magic-faeriefire.ogg
    [/sound]
    [message]
        speaker=wjinn
        message= _ "I see it now. This day will be different. You are going to meet a strange person coming from far away. He will test you, but this will change your life forever and open many new opportunities."
    [/message]
    [message]
        speaker=Mehir
        message= _ "Nothing new. Stuff like that happens to me everyday but thanks anyway."
    [/message]
    [message]
        speaker=wjinn
        message= _ "Wait! There is going to be a fight near the Central Palace. There will be some losses. That person - he is more powerful than you'll think. You'd better watch out!"
    [/message]
    {IF_VAR boughtelemental equals yes (
        [then]
            [message]
                speaker=Mehir
                message= _ "A brawl near the Central Palace? Good thing I bought a water elemental then. Thanks for the warning."
            [/message]
        [/then]
        [else]
            [message]
                speaker=Mehir
                message= _ "A brawl near the Central Palace? Damn, maybe I should've bought the overpriced elemental... Well, too late to turn back, thanks for the warning."
            [/message]
        [/else]
    )}

    {VARIABLE boughtelemental yes}

    {VARIABLE jinni_prophecy yes}
#enddef
#define JINN_DIALOG
    {REMOVE_IMAGE 4 5}
    [message]
        speaker=wjinn
        message= _ "Ah, greetings, human. Nice to meet you."
    [/message]
    [message]
        speaker=Mehir
        message= _ "May I ask what is a Wonderful Jinni doing here in the midtiers? Oh, and why are you alone? Where is your master?"
    [/message]
    [message]
        speaker=wjinn
        message= _ "A master? No, I have none. I am a free being. I used to be owned by a human a few years ago, but I decided to choose my own path. My master accepted this decision wholeheartedly, and now we are simply best friends. He lives in the higher tiers, in case you're wondering."
    [/message]
    [message]
        speaker=Mehir
        message= _ "I see. Well, forgive me, but may I ask you a question? It's not every day that I run into your kind, after all."
    [/message]
    [message]
        speaker=wjinn
        message= _ "Yes, please. I hope my knowledge will prove useful."
    [/message]
    [message]
        speaker=Mehir
        message= _ "I've heard that powerful jinn like yourself can foresee the future. Is that true?"
    [/message]
    [message]
        speaker=wjinn
        message= _ "Yes, to a certain extent. I can predict the approximate outcome of things that are about to happen really soon, but the the further in time I look, the less accurate the predictions become, due to many factors, including the very knowledge about the prediction itself."
    [/message]
    [message]
        speaker=Mehir
        message= _ "Hmm, this sounds interesting. What do you mean by 'really soon' though, seconds? Minutes? Hours? Days?"
    [/message]
    [message]
        speaker=wjinn
        message= _ "Foreseeing several minutes ahead is quite easy, hours not so much. But don't forget these are only probabilities - things may change. Also, this task is quite exhausting, so we high-level Jinn rarely use this ability of ours."
    [/message]
    [message]
        speaker=Mehir
        message= _ "I see. So... would you tell me what will happen to me in the next hour or so?"
    [/message]
    [message]
        speaker=wjinn
        message= _ "Yes, but... for a price. This will cost you 3 gold."
    [/message]
    [message]
        speaker=Mehir
        image=portraits/mehir-angry.png
        message= _ "You've got to be kidding me! You want my money too? Everyone in this city wants my money! It looks like even magical beings are spoiled! I thought Jinn aren't materialistic..."
    [/message]
    [message]
        speaker=wjinn
        message= _ "Well, you see, living in al-Kamija is quite expensive, especially for an independent wonderful jinni like me. I need to pay rent, bills, do some shopping from time to time, hire carpet ferrymen etc."
    [/message]
    [message]
        speaker=Mehir
        message= _ "Wait, you use carpet ferrymen services? But you can fly by yourself! You're a Jinni after all!"
    [/message]
    [message]
        speaker=wjinn
        message= _ "As a free being I have the right to be lazy sometimes, you know? Back to business - do you want to know your future? As I said this will be 3 gold paid upfront."
    [/message]
    [store_gold]
        side=1
        variable=mehirgold
    [/store_gold]

    [message]
        speaker=Mehir
        message= _ "<span font-style='italic'>*to himself* Hmmmm...</span>"
        [option]
            image="misc/blank-hex.png"
            label= _ "Maybe some other time."
            [command]
                [message]
                    speaker=wjinn
                    message= _ "If you change your mind, feel free to come back. I'll be staying here for a few hours, waiting for Ahmed to fix some things for me."
                [/message]
            [/command]
        [/option]
        [option]
            image="attacks/reality-warp.png"
            label= _ "Learn about your future (costs 3 gold)"
            [show_if]
                [variable]
                    name=mehirgold
                    greater_than=2
                [/variable]
            [/show_if]
            [command]
                [gold]
                    side=1
                    amount=-3
                [/gold]
                [sound]
                    name=gold.ogg
                [/sound]
                {JINN_PROPHECY}
                {REMOVE_IMAGE 7 5}
            [/command]
        [/option]
        [option]
            image="portraits/summoners/horhami.png~SCALE(72,72)"
            label= _ "Use a trick"
            [show_if]
                [variable]
                    name=badass_mode_active
                    equals=yes
                [/variable]
                [and]
                    [variable]
                        name=met_horhami
                        equals=yes
                    [/variable]
                [/and]
            [/show_if]
            [command]
                {MODIFY_UNIT id=Mehir profile "portraits/mehir.png~BLIT(misc/sunglasses.png)"}
                [message]
                    speaker=Mehir
                    message= _ "What if I shared some valuable information with you instead of the money?"
                [/message]
                [message]
                    speaker=wjinn
                    message= _ "Well, it depends on what you want to tell me."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "It just so happens that I know a hot blue chick of your kind. Said she dates Jinn only, and I think she might have noticed you specifically. You might have high chances with her."
                [/message]
                [message]
                    speaker=wjinn
                    message= _ "Really? Where is she?"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Not so fast, hotshot. First tell me my future."
                [/message]
                {JINN_PROPHECY}
                {REMOVE_IMAGE 4 5}
                [message]
                    speaker=wjinn
                    message= _ "I told you the future, so now tell me, where is she? I must meet her!"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Her name is Theivya. She is guarding the gate to the bazaar. Too bad she can't move away from her post. You will have to ask the High Council to relieve her, if you want to take her for a walk."
                [/message]
                [message]
                    speaker=wjinn
                    message= _ "Thank you, human. If she likes me, I'll talk with the Council."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "And tell them I want to be better paid. I too have the right to be materialistic sometimes."
                [/message]
                {MOVE_UNIT id=wjinn 3 6}
                [kill]
                    id=wjinn
                    animate=no
                [/kill]
                {VARIABLE jinn_and_rhami_dated yes}
            [/command]
        [/option]
    [/message]
#enddef

#define PROLOGUE_SET_SCENERY_ITEMS
    [item]
        x=18
        y=16
        halo=scenery/m00-border-bottom.png
    [/item]
    [item]
        x,y=12,6
        halo=units/summoners-humans/carpetmaster[1,2,3,2].png~RC(magenta>blue):150
    [/item]
    [item]
        x,y=15,6
        halo=units/summoners-enchanted-ones/jinn[2,1,2,3].png~RC(magenta>red):150
    [/item]
    [item]
        x=6
        y=9
        halo=scenery/mask-bridge.png
    [/item]
    [item]
        x=21
        y=14
        halo=scenery/mask-dome.png
    [/item]
    [item]
        x=1
        y=9
        halo=scenery/m00-border-left.png
    [/item]
    [item]
        x=14
        y=6
        halo=scenery/bazaar.png
    [/item]
    [item]
        x=13
        y=7
        image=scenery/bazaar-a.png
    [/item]
    [item]
        x=14
        y=6
        image=scenery/bazaar-b.png
    [/item]
#enddef

[scenario]
    id=00_Prologue
    next_scenario=01_Highest_Tiers
    name= _ "Morning in al-Kamija"
    map_data="{~add-ons/To_Lands_Unknown/maps/00_Prologue.map}"
    turns=-1
    victory_when_enemies_defeated=no

    {MORNING_TLU}

    {SCENARIO_MUSIC wanderer.ogg}

    {STORYTXT_ALKAMIJA}
    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=TLU_Mehir_Guard
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes
        variation=noglove
        profile=portraits/mehir.png
#ifdef EASY
        [modifications]
            {TRAIT_INTELLIGENT}
        [/modifications]
        experience=16
#endif
        recruit=EoMa_Novice_Summoner

        {GOLD 50 34 20}
        income=-2
        shroud=yes
    [/side]

    [side]
        side=2
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Citizens"
        color=green
        no_leader=yes
        gold=0
        income=0
        {UNIT 2 (TLU_carpettaxi) 13 8 (
            id=ferryman
            name= _ "Carpet Ferryman"
            profile="portraits/ferryman.png~RIGHT()"
        )}
        {UNIT 2 (EoMa_HoRhami) 4 13 (
            id=gate_guardian
            name= _ "Gate Guardian Theivya"
            facing=se
        )}
        {UNIT 2 (TLU_Merchant) 14 6 (
            id=merchant
            name= _ "Yakub"
            facing=sw
        )}
        {UNIT 2 (EoMa_Water_Elemental) 14 7 (
            id=waterelemental
            facing=sw
            upkeep=loyal
        )}
        {UNIT 2 (TLU_Elder) 11 17 (
            id=elder
            generate_name=yes
            facing=sw
        )}
    [/side]
    [side]
        side=3
        controller=ai
        team_name=animhack
        user_team_name= _ "."
        hidden=yes
        color=black
        no_leader=yes
        gold=0
        income=0

        [unit]
            type=TLU_animhack
            variation=carpet-highway1
            side=3
            x=11
            y=14
            facing=se
            placement,overwrite=map,yes
        [/unit]
        [unit]
            type=TLU_animhack
            variation=carpet-highway2
            side=3
            x=10
            y=14
            facing=nw
            placement,overwrite=map,yes
        [/unit]
        [unit]
            type=TLU_animhack
            variation=carpet-highway3
            side=3
            x=12
            y=13
            facing=se
            placement,overwrite=map,yes
        [/unit]
        [unit]
            type=TLU_animhack
            variation=carpet-highway4
            side=3
            x=13
            y=13
            facing=nw
            placement,overwrite=map,yes
        [/unit]
        [unit]
            type=TLU_animhack
            variation=carpet-highway5
            side=3
            x=15
            y=13
            facing=nw
            placement,overwrite=map,yes
        [/unit]
    [/side]

    #preload
    [event]
        name=preload

        [color_adjust]
            red,green,blue=-500,-500,-500
        [/color_adjust]
    [/event]

    #prestart
    [event]
        name=prestart

        [hide_unit]
            [filter_side]
            [/filter_side]
        [/hide_unit]

        [item]
            x=5
            y=15
            halo=scenery/mask-wall.png
        [/item]

        [lock_view]
        [/lock_view]

        [change_theme]
            theme="Cutscene_Minimal"
        [/change_theme]
    [/event]

    #start
    [event]
        name=start

        [disallow_end_turn]
        [/disallow_end_turn]

        [delay]
            time=1000
        [/delay]

        {TELEPORT_UNIT id=Mehir 3 16}

        ##opening
        [color_adjust]
            red,green,blue=-512,-512,-512
        [/color_adjust]
        [remove_shroud]
            side=1
        [/remove_shroud]
        {SCROLL_TO 16 8}
        [redraw]
        [/redraw]

        [lock_view]
        [/lock_view]
        [unit]
            type=TLU_animhack
            side=1
            x=16
            y=8
            facing=se
            placement,overwrite=map,yes
        [/unit]

        [animate_unit]
            flag=cutscene_author
            [filter]
                x,y=16,8
            [/filter]
        [/animate_unit]

        [kill]
            x,y=16,8
            animate=no
        [/kill]
        [change_theme]
            theme=""
        [/change_theme]
        [place_shroud]
            side=1
        [/place_shroud]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [color_adjust]
            red,green,blue=0,0,0
        [/color_adjust]
        [unlock_view]
        [/unlock_view]

        {FADE_IN}
        [unhide_unit]
            [filter_side]
            [/filter_side]
        [/unhide_unit]
        [delay]
            time=1000
        [/delay]

        [redraw]
        [/redraw]
        [message]
            speaker=Mehir
            message= _ "*yawn*"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Another day, doomed to be wasted standing in one place all day, guarding a palace-city with nobody to defend it from. We’re in the middle of the desert for crying out loud, there are no threats for miles, and the only thing I have to pass the time here is commanding a bunch of morons and breaking up tavern brawls."
        [/message]
        [message]
            speaker=Mehir
            message= _ "And to think I wanted to be a city guard, with so many more exciting alternatives..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "On the bright side, at least I get a majestic view of the highest tiers of the city, and standing in one place all day long does pay the bills..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Anyway, it would probably be a good idea to buy a few things at the bazaar, and maybe get my enchanted glove fixed..."
        [/message]
        {HIGHLIGHT_IMAGE 5 16 "items/gohere.png" ()}
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "Note: though unable to normally advance, Mehir has custom AMLAs (After Max Level Advancements), but as the story progresses he may advance by receiving promotions due to his actions (like in real life)."
        [/message]
        [objectives]
            side=1
            [objective]
                description= _ "Leave the room"
                condition=win
            [/objective]
            note= _ "This is a non-combat scenario:
 -Mehir's movement refills after each move.
 -You cannot skip your turn"
        [/objectives]
    [/event]

    #exit room
    [event]
        name=moveto
        id=room_exit

        [filter]
            id=Mehir
            x,y=5,16
        [/filter]

        [message]
            speaker=narrator
            caption= _ "Choose gameplay mode"
            image=portraits/narrator.png
            message= _ "This campaign offers two different ways of playing. You can proceed with a normal mode (in which Mehir behaves mostly reasonably) or activate a special 'badass' mode which offers an alternative story progression with different dialogs, events and mission goals (Mehir acts much less reasonable in this mode).

Choose wisely as once set, you cannot change the mode later in your current playthrough!"
            [option]
                image="portraits/mehir.png~CROP(131,50,130,130)~SCALE(72,72)"
                label= _ "Normal Mode (good for new players or those who seek a serious gameplay)"
                [command]
                    {VARIABLE badass_mode_active no}
                [/command]
            [/option]
            [option]
                image="portraits/mehir.png~BLIT(misc/sunglasses.png)~CROP(131,50,130,130)~SCALE(72,72)"
                label= _ "Badass Mode (choose it if you know the campaign well or you seek a less serious gameplay)"
                [command]
                    {VARIABLE badass_mode_active yes}
                [/command]
            [/option]
        [/message]

        [hide_unit]
            id=Mehir
        [/hide_unit]

        {FAKE_UNIT_MOVE 5 7 16 15 1 TLU_Mehir_Guard (variation=noglove)}
        {REMOVE_IMAGE 5 15}
        {REMOVE_IMAGE 5 16}
        [remove_shroud]
            side=1
            x=0-99
            y=0-99
        [/remove_shroud]
        {TELEPORT_UNIT id=Mehir 7 15}
        {MODIFY_UNIT id=Mehir moves 5}
        [unhide_unit]
            id=Mehir
        [/unhide_unit]

        {PROLOGUE_SET_SCENERY_ITEMS}

        #marks interactable NPCs:

        [item]
            x,y=4,13
            halo=anim/exclamation-1.png:140,anim/exclamation-2.png:140,anim/exclamation-1.png:140,anim/exclamation-3.png:140
        [/item]

        [item]
            x,y=14,6
            halo=anim/exclamation-1.png:140,anim/exclamation-2.png:140,anim/exclamation-1.png:140,anim/exclamation-3.png:140
        [/item]

        [item]
            x,y=11,17
            halo=anim/exclamation-1.png:140,anim/exclamation-2.png:140,anim/exclamation-1.png:140,anim/exclamation-3.png:140
        [/item]

        [message]
            speaker=Mehir
            image=portraits/mehir-happy.png
            message= _ "Ah, another lovely day in al-Kamija!"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Time to visit the bazaar, grab a few things here and there, maybe even check a trade license or two along the way..."
            [/message]
        ) (
            [message]
                speaker=Mehir
                message= _ "Time to visit the bazaar, grab a few things here and there..."
            [/message]
        )}
        {SCROLL_TO 14 6}
        [delay]
            time=1000
        [/delay]
        {HIGHLIGHT_IMAGE 2 13 "items/gohere.png" ()}
        [objectives]
            side=1
            [objective]
                description= _ "Visit the bazaar"
                condition=win
            [/objective]
            note= _ "This is a non-combat scenario:
-Mehir's movement refills after each move.
-You cannot skip your turn
-You can interact with NPCs that have yellow exclamation marks by moving next to them."
        [/objectives]
    [/event]

    #cross bridge
    [event]
        name=moveto
        id=bridge_event
        first_time_only=no
        [filter]
            id=Mehir
            x,y=2,13
        [/filter]

        {REMOVE_IMAGE 2 13}
        [hide_unit]
            id=Mehir
        [/hide_unit]
        {SCROLL_TO 8 8}
        {TELEPORT_UNIT id=Mehir 12 7}
        [lock_view]
        [/lock_view]
        [unit]
            type=TLU_animhack
            side=3
            x=4
            y=9
            facing=ne
            placement,overwrite=map,yes
        [/unit]

        [animate_unit]
            flag=mehir-bridge
            [filter]
                x,y=4,9
            [/filter]
        [/animate_unit]

        [kill]
            x,y=4,9
            animate=no
        [/kill]
        [unlock_view]
        [/unlock_view]

        {MODIFY_UNIT id=Mehir facing se}
        [unhide_unit]
            id=Mehir
        [/unhide_unit]
    [/event]

    #refill moves
    [event]
        name=moveto
        first_time_only=no
        [allow_undo]
        [/allow_undo]

        {MODIFY_UNIT id=Mehir moves 5}
        {MODIFY_UNIT id=waterelemental moves 6}
    [/event]

    #try going back to bed
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            id=Mehir
            x,y=3,16
        [/filter]
        [message]
            speaker=Mehir
            message= _ "I've got more important things to do than taking a nap."
        [/message]
    [/event]

    #Guardian
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            id=Mehir
            [filter_adjacent]
                id=gate_guardian
            [/filter_adjacent]
        [/filter]
        [allow_undo]
        [/allow_undo]

        [message]
            speaker=gate_guardian
            message= _ "Greetings, sergeant Mehir."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Hello Theivya. Any reports?"
        [/message]
        [message]
            speaker=gate_guardian
            message= _ "Nothing worth reporting happened during nighttime, everything is calm as usual."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Same boring routine as usual eh? At this point part of me almost wants something to go wrong, so I am at least no longer bored... By the way, I always wondered... for how long have you been guarding this post? I've been seeing you all the time here."
        [/message]
        [message]
            speaker=gate_guardian
            message= _ "I was assigned to this post 242 years ago by the High Council."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Heh, having to stand in one place as a guard for what feels like an eternity, I can sympathize. Well, you still look quite good after all these years."
        [/message]
        [message]
            speaker=gate_guardian
            message= _ "Of course, we magical beings never age."
        [/message]

        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "By the way, beautiful, do you have plans for tonight? We could go for a walk in the highest tiers, or maybe stay at my place maybe."
            [/message]
            [message]
                speaker=gate_guardian
                message= _ "Before you get your hopes up, I only date jinn. Much more interesting and intelligent than most humans to be honest. Now that I think about it, I saw a wonderful jinn flying nearby, he looked quite handsome..."
            [/message]
            [message]
                speaker=Mehir
                message= _ "*hmmmm... something tells me this information might be useful later*"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Alright, won't bother you then. Time to go to the bazaar, see you!"
            [/message]
            [message]
                speaker=gate_guardian
                message= _ "See you, have a nice day."
            [/message]
            {VARIABLE met_horhami yes}
        ) (
            [message]
                speaker=Mehir
                message= _ "Lucky you! At least your kind serves us so we can all enjoy life in this beautiful place. Keep up the good work and have a nice day!"
            [/message]
            [message]
                speaker=gate_guardian
                message= _ "Have a nice day too."
            [/message]
        )}
        {REMOVE_IMAGE 4 13}
    [/event]

    #Elder
    [event]
        name=moveto
        first_time_only=yes

        [filter]
            id=Mehir
            [filter_adjacent]
                id=elder
            [/filter_adjacent]
        [/filter]
        {REMOVE_IMAGE 11 17}
        [message]
            speaker=elder
            message= _ "Them youths these days with their fancy carpets, and elementals wiping their butts! Back in my day..."
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Times change, old fart, deal with it. Would you rather go back to the times when our ancestors had to live in caves and eat mushrooms to survive, without abyssal magic?"
            [/message]
            [message]
                speaker=elder
                message= _ "Hmph, I suppose you make a point..."
            [/message]
        ) ()}
    [/event]

    #Merchant
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Mehir
            [filter_adjacent]
                id=merchant
            [/filter_adjacent]
        [/filter]
        [allow_undo]
        [/allow_undo]
        {IF_VAR metmerchant not_equals yes (
            [then]
                [message]
                    speaker=merchant
                    message= _ "Ah, good day! What wares can I interest you in?"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "I'll buy a new food summoning device, the one for five gold. Mine broke yesterday."
                [/message]
                [message]
                    speaker=merchant
                    message= _ "Here you go!"
                [/message]
                [gold]
                    side=1
                    amount=-5
                [/gold]
                [sound]
                    name=gold.ogg
                [/sound]
                [message]
                    speaker=merchant
                    message= _ "By the way, I've got a special deal for you, a water elemental for 22 gold!"
                [/message]
                [message]
                    speaker=Mehir
                    image=portraits/mehir-angry.png
                    message= _ "What?! You're charging twenty-two gold for a water elemental?! A summoning scroll for one costs only 16 gold! Your prices are outragerous!"
                [/message]
                [message]
                    speaker=merchant
                    message= _ "Don't forget that this one's pre-summoned. Most people aren't skilled at summoning, and are willing to pay higher for an easier way to get their own elemental."
                [/message]
                [message]
                    speaker=Mehir
                    image=portraits/mehir-angry.png
                    message= _ "Still, summoning an elemental takes so little effort to justify this blatant theft!"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Besides, unlike some average civilian, I am pretty good at using summon scrolls. Unless you reduce the price, I could just go to another merchant that sells them, and save a whole 6 gold."
                [/message]
                [message]
                    speaker=merchant
                    message= _ "Hmph, fine, how about 20 gold? But I won't reduce the price any further, mind you, I still need to make a profit, don't forget that."
                [/message]
                {WATER_ELEMENTAL_TEXT}
                {VARIABLE metmerchant yes}
                [message]
                    speaker=Mehir
                    message= _ "<i>*to himself* now that I bought what I needed, it's time to visit an enchanter's workshop. I need my enchanted glove to be fixed. Without this weapon working I won't be able to guard the streets effectively.</i>"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "<i>*to himself* Hmm... I need a flying carpet to get there.</i>"
                [/message]
                {HIGHLIGHT_IMAGE 12 7 "items/gohere.png" ()}
                [item]
                    x,y=13,8
                    halo=anim/exclamation-1.png:140,anim/exclamation-2.png:140,anim/exclamation-1.png:140,anim/exclamation-3.png:140
                [/item]
                [objectives]
                    side=1
                    [objective]
                        description= _ "Visit the Enchanter"
                        condition=win
                    [/objective]
                    note= _ "This is a non-combat scenario:
-Mehir's movement refills after each move.
-You cannot skip your turn
-You can interact with NPCs that have yellow exclamation marks by moving next to them."
                [/objectives]
            [/then]
            [else]
                {IF_VAR boughtelemental not_equals yes (
                    [and]
                        [variable]
                            name=mehircantafford
                            not_equals=yes
                        [/variable]
                    [/and]
                    [then]
                        [message]
                            speaker=merchant
                            message= _ "Changed your mind about the elemental?"
                        [/message]
                        {WATER_ELEMENTAL_TEXT}
                    [/then]
                    [else]
                        [message]
                            speaker=Mehir
                            message= _ "<i>*to himself* I don't think I need to buy anything else.</i>"
                        [/message]
                    [/else]
                )}
            [/else]
        )}
        {REMOVE_IMAGE 14 6}
        #quickfix:
        [item]
            x=14
            y=6
            halo=scenery/bazaar.png
        [/item]
        {CLEAR_VARIABLE mehirgold}
    [/event]

    #leave bazaar
    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=Mehir
            x,y=12,7
        [/filter]

        {IF_VAR metmerchant equals yes (
            [then]
                [message]
                    speaker=narrator
                    message= _ "Leave the bazaar to visit the Enchanter?"
                    [option]
                        image="misc/blank-hex.png"
                        label= _ "Not yet"
                        [command]
                        [/command]
                    [/option]
                    [option]
                        image="units/summoners-humans/carpetrider2.png~RC(magenta>green)"
                        label= _ "Yes"
                        [command]
                            [message]
                                speaker=ferryman
                                message= _ "How can I help you?"
                            [/message]
                            [message]
                                speaker=Mehir
                                message= _ "I need to get to the nearby enchanter's workshop."
                            [/message]
                            [message]
                                speaker=ferryman
                                message= _ "Sure. That will be two gold."
                            [/message]
                            [message]
                                speaker=Mehir
                                image=portraits/mehir-angry.png
                                message= _ "What?! It's only in the next tower right there!"
                            [/message]
                            [message]
                                speaker=ferryman
                                message= _ "You wanna ride, you pay. It's your choice."
                            [/message]
                            [message]
                                speaker=Mehir
                                image=portraits/mehir-angry.png
                                message= _ "Unbelievable! We are living in such an advanced age, and everyone still only wants more and more money!"
                            [/message]

                            {BADASS_MODE_CHANGE (
                                [delay]
                                    time=500
                                [/delay]
                                [message]
                                    speaker=Mehir
                                    message= _ "Do you know who I am?"
                                [/message]
                                [message]
                                    speaker=ferryman
                                    message= _ "I don't give a crap - 2 gold coins or go on foot."
                                [/message]
                                [message]
                                    speaker=Mehir
                                    image="portraits/mehir-angry.png~BLIT(misc/sunglasses.png)"
                                    message= _ "I am the leader of the city guard and I am on duty. Now get out!"
                                [/message]
                                [message]
                                    speaker=ferryman
                                    message= _ "Excuse me?"
                                [/message]
                                [message]
                                    speaker=Mehir
                                    image="portraits/mehir-angry.png~BLIT(misc/sunglasses.png)"
                                    message= _ "I said, get out! I am confiscating your damn carpet! Now step aside..."
                                [/message]
                                [message]
                                    speaker=ferryman
                                    message= _ "Wha...?!"
                                [/message]
                                [object]
                                    silent=yes
                                    duration=forever
                                    [filter]
                                        id=Mehir
                                    [/filter]
                                    [effect]
                                        apply_to=variation
                                        name=carpet
                                    [/effect]
                                [/object]
                                {REMOVE_IMAGE 13 8}
                                [kill]
                                    id=ferryman
                                    animate=no
                                [/kill]
                                [teleport]
                                    [filter]
                                        id=Mehir
                                    [/filter]
                                    x,y=13,8
                                    check_passability=no
                                [/teleport]
                                {UNIT 2 (TLU_carpettaxi) 12 7 (
                                    id=ferryman
                                    name= _ "Carpet Ferryman"
                                    variation=foot
                                )}
                                [message]
                                    speaker=ferryman
                                    image=portraits/ferryman-angry.png
                                    message= _ "This is madness! I'm gonna write a complaint to the High Council!"
                                [/message]
                                [message]
                                    speaker=Mehir
                                    message= _ "Ha, good luck with that."
                                [/message]
                            ) (
                                #no-badass
                                [message]
                                    speaker=ferryman
                                    message= _ "Listen pal, talk about intrinsic value crap all you want, but I need to feed my family. We are from the lower tiers, and life is harsh there, you know."
                                [/message]
                                [message]
                                    speaker=Mehir
                                    message= _ "*sigh* Fine, how about this: I'll pay you 3 coins, but instead of just one trip I want your services for a whole hour."
                                [/message]
                                [message]
                                    speaker=ferryman
                                    message= _ "Now that's something! Climb on."
                                [/message]
                                [gold]
                                    side=1
                                    amount=-3
                                [/gold]
                                [hide_unit]
                                    id=Mehir
                                [/hide_unit]
                            )}

                            {REMOVE_IMAGE 12 7}
                            {REMOVE_IMAGE 13 8}
                            {BADASS_MODE_CHANGE (
                                [if]
                                    [have_unit]
                                        side=1
                                        type=EoMa_Water_Elemental
                                    [/have_unit]
                                    [then]
                                        [hide_unit]
                                            type=EoMa_Water_Elemental
                                        [/hide_unit]
                                        [object]
                                            silent=yes
                                            duration=forever
                                            [filter]
                                                id=Mehir
                                            [/filter]
                                            [effect]
                                                apply_to=variation
                                                name=carpet_waterelem
                                            [/effect]
                                        [/object]
                                    [/then]
                                [/if]
                                {MOVE_UNIT id=Mehir 21 12}
                            ) (
                                [if]
                                    [have_unit]
                                        side=1
                                        type=EoMa_Water_Elemental
                                    [/have_unit]
                                    [then]
                                        [hide_unit]
                                            type=EoMa_Water_Elemental
                                        [/hide_unit]
                                        [object]
                                            silent=yes
                                            duration=forever
                                            [filter]
                                                id=ferryman
                                            [/filter]
                                            [effect]
                                                apply_to=variation
                                                name=mehir_waterelem
                                            [/effect]
                                        [/object]
                                    [/then]
                                    [else]
                                        [object]
                                            silent=yes
                                            duration=forever
                                            [filter]
                                                id=ferryman
                                            [/filter]
                                            [effect]
                                                apply_to=variation
                                                name=mehir
                                            [/effect]
                                        [/object]
                                    [/else]
                                [/if]
                                {MOVE_UNIT id=ferryman 21 12}
                            )}
                            {SCROLL_TO 21 12}
                            [delay]
                                time=200
                            [/delay]
                            [fire_event]
                                name=enter_shop
                            [/fire_event]
                        [/command]
                    [/option]
                [/message]
            [/then]
        )}
    [/event]

    #enter shop
    [event]
        name=enter_shop
        first_time_only=no
        {BADASS_MODE_CHANGE (
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=Mehir
                [/filter]
                [effect]
                    apply_to=variation
                    name=noglove
                [/effect]
            [/object]
        ) ()}
        [store_unit]
            [filter]
                [not]
                    id=Mehir
                [/not]
            [/filter]
            variable=memo
            kill=yes
        [/store_unit]
        [remove_item]
            x=1-99
            y=1-99
        [/remove_item]
        [teleport]
            [filter]
                id=Mehir
            [/filter]
            x,y=8,7
            check_passability=no
        [/teleport]
        [replace_map]
            map_file="00_Prologue_a.map"
            expand=yes
            shrink=yes
        [/replace_map]
        [unhide_unit]
            id=Mehir
        [/unhide_unit]
        {IF_VAR beentoshop not_equals yes (
            [then]
                {VARIABLE beentoshop yes}
                {UNIT 2 (TLU_Enchanter) 7 5 (
                    id=enchanter
                    name= _ "Ahmed"
                    facing=sw
                )}
                [item]
                    x,y=7,5
                    halo=anim/exclamation-1.png:140,anim/exclamation-2.png:140,anim/exclamation-1.png:140,anim/exclamation-3.png:140
                [/item]
                {MOVE_UNIT id=Mehir 7 6}
                {MODIFY_UNIT id=Mehir facing n}

                {ENCHANTER_DIALOG}

                {UNIT 2 (EoMa_Wonderful_Jinn) 3 6 (
                    id=wjinn
                    name= _ "Wonderful Jinn"
                    facing=se
                )}
                {MOVE_UNIT id=wjinn 4 5}
                [item]
                    x,y=4,5
                    halo=anim/exclamation-1.png:140,anim/exclamation-2.png:140,anim/exclamation-1.png:140,anim/exclamation-3.png:140
                [/item]
                {VARIABLE inshop yes}
            [/then]
            [else]
                [foreach]
                    array=memo_shop
                    [do]
                        [unstore_unit]
                            variable=this_item
                            check_passability=no
                        [/unstore_unit]
                    [/do]
                [/foreach]
                {VARIABLE inshop yes}
            [/else]
        )}
        [redraw]
        [/redraw]
    [/event]

    #Wonderful Jinn
    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=Mehir
            [filter_adjacent]
                id=wjinn
            [/filter_adjacent]
        [/filter]

        {IF_VAR metjinn equals yes (
            [else]
                {JINN_DIALOG}
                {VARIABLE metjinn yes}
            [/else]
        )}
    [/event]

    #leave shop trigger
    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=Mehir
            x,y=7,7
        [/filter]

        {IF_VAR inshop equals yes (
            [then]
                {VARIABLE inshop no}
                [fire_event]
                    name=leave_shop
                [/fire_event]
            [/then]
        )}
    [/event]

    #leave shop
    [event]
        name=leave_shop
        first_time_only=no

        [remove_item]
            x=1-99
            y=1-99
        [/remove_item]
        [store_unit]
            [filter]
                [not]
                    id=Mehir
                [/not]
            [/filter]
            variable=memo_shop
            kill=yes
        [/store_unit]
        [replace_map]
            map_file=00_Prologue.map
            expand=yes
            shrink=yes
        [/replace_map]
        [teleport]
            [filter]
                id=Mehir
            [/filter]
            x,y=21,11
            check_passability=no
        [/teleport]
        [foreach]
            array=memo
            [do]
                [unstore_unit]
                    variable=this_item
                    check_passability=no
                [/unstore_unit]
            [/do]
        [/foreach]

        [hide_unit]
            id=waterelemental
        [/hide_unit]

        {BADASS_MODE_CHANGE (
            [if]
                [have_unit]
                    side=1
                    type=EoMa_Water_Elemental
                [/have_unit]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            id=Mehir
                        [/filter]
                        [effect]
                            apply_to=variation
                            name=carpet_waterelem
                        [/effect]
                    [/object]
                [/then]
                [else]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            id=Mehir
                        [/filter]
                        [effect]
                            apply_to=variation
                            name=carpet
                        [/effect]
                    [/object]
                [/else]
            [/if]
        ) (
            {TELEPORT_UNIT id=ferryman 21 12}
            {MODIFY_UNIT id=ferryman facing se}
            #heal ferryman in case he looses hp while waiting for Mehir...
            [heal_unit]
                [filter]
                    id=ferryman
                [/filter]
                animate=no
            [/heal_unit]
            [if]
                [have_unit]
                    side=1
                    type=EoMa_Water_Elemental
                [/have_unit]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            id=ferryman
                        [/filter]
                        [effect]
                            apply_to=variation
                            name=waterelem
                        [/effect]
                    [/object]
                [/then]
                [else]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            id=ferryman
                        [/filter]
                        [effect]
                            apply_to=variation
                            name=
                        [/effect]
                    [/object]
                [/else]
            [/if]
        )}
        [redraw]
        [/redraw]
        {PROLOGUE_SET_SCENERY_ITEMS}
        [redraw]
        [/redraw]
        {SCROLL_TO 21 11}
        {CLEAR_VARIABLE inshop}

        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "And now to the highest tiers..."
            [/message]
            {MOVE_UNIT id=Mehir 33 14}
        ) (
            [message]
                speaker=ferryman
                message= _ "Where next?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "The highest tiers, of course!"
            [/message]
            [hide_unit]
                id=Mehir
            [/hide_unit]
            [if]
                [have_unit]
                    side=1
                    type=EoMa_Water_Elemental
                [/have_unit]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            id=ferryman
                        [/filter]
                        [effect]
                            apply_to=variation
                            name=mehir_waterelem
                        [/effect]
                    [/object]
                [/then]
                [else]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            id=ferryman
                        [/filter]
                        [effect]
                            apply_to=variation
                            name=mehir
                        [/effect]
                    [/object]
                [/else]
            [/if]
            {MOVE_UNIT id=ferryman 33 14}
        )}
        {CLEAR_VARIABLE mehirgold}
        {CLEAR_VARIABLE mehircantafford}
        {CLEAR_VARIABLE boughtelemental}
        {CLEAR_VARIABLE metmerchant}
        {CLEAR_VARIABLE metjinn}
        {CLEAR_VARIABLE beentoshop}
        {CLEAR_VARIABLE memo}
        {CLEAR_VARIABLE memo_shop}
        [endlevel]
            result=victory
            bonus=no
            {NEW_GOLD_CARRYOVER 100}
            linger_mode=no
            carryover_report=no
        [/endlevel]
    [/event]

    {SUMMONER_LOCK}
    {DEATH_MEHIR}

    {TLU_S00_TERRAIN}
[/scenario]
